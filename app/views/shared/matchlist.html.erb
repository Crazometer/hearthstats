<%
	items_per_page = CGI.parse(request.query_string)['items'].first
    if items_per_page.nil? || !((Float(items_per_page) rescue false))
      items_per_page = 20
    end
    
	sort_field = CGI.parse(request.query_string)['sort'].first
    if sort_field.nil? || !sort_field.match("created_at|duration")
      sort_field = "created_at"
    end
    
    order_field = CGI.parse(request.query_string)['order'].first
    if order_field.nil? || !order_field.match("asc|desc")
      order_field = "desc"
    end
    
    matches = matches.order(sort_field + " " + (order_field == "asc" ? "ASC" : "DESC"))
    matches = matches.paginate(:page => params[:page], :per_page => items_per_page)
%>
<% if filter %>
	<form id="matchesFilter" method="get" class="data-turboform">
		<p>Show
			<select name="items">
				<% [10, 20, 50, 100].each do |num| %>
					<option value="<%= num %>" <%= items_per_page.to_s == num.to_s ? "selected=\"selected\"" : "" %>><%= num %></option>
				<% end %> 
			</select>
			of <strong><%= number_with_delimiter(matches.count, :delimiter => ',') %></strong> matches 
			sorted by
			<select name="sort">
				<option value="created_at" <%= sort_field == "created_at" ? "selected=\"selected\"" : "" %>>created</option>
				<option value="duration" <%= sort_field == "duration" ? "selected=\"selected\"" : "" %>>duration</option>
			</select>
			<select name="order">
				<option value="asc">ascending</option>
				<option value="desc" <%= order_field == "desc" ? "selected=\"selected\"" : "" %>>descending</option>
			</select>
			
		</p>
	</form>
<% end %>
<table class="table table-bordered table-striped table-condensed flip-content">
	<thead class="flip-content">
	    <tr>
		    <% if type != "Arena" %>
		    	<th>Your Deck</th>
		    <% end %>
		    <th>Opponent Class</th>
		    <th>Result</th>
		    <th>Coin</th>
		    <% if type != "Arena" %>
	    		<th><%= type == "Constructed" ? "Rank" : "Mode" %></th>
	    	<% end %>
		    <th>Opponent Name</th>
		    <th>Rounds</th>
		    <th>Duration</th>
		    <th>Created</th>
		    <th>Options</th>
		</tr>
	</thead>
	<tbody>
		<% matches.each do |match| %>
			<tr>
				<% if type != "Arena" %>
					<td><%= match.deck.nil? ? "null" : link_to(match.deck.name, deck_path(match.deck)) %></td>
				<% end %>
				<td><%= match.oppclass.nil? ? "null" : match.oppclass.name %></td>
				<td class="<%= get_name(match,'Result') %>"><%= get_name(match,"Result") %></td>
				<td><%= !match.coin ? "No" : "" %> Coin</td>
				<% if type != "Arena" %>
					<td>
						<% if !match.mode.nil? %>
							<% if match.mode.name == "Ranked" && !match.rank.nil? %>
								<%= match.rank.id %> - <%= match.rank.name %>
							<% else %>
								<%= match.mode.name %>
							<% end %>
								
						<% else %>
							null
						<% end %>
					</td>
				<% end %>
				<td><%= match.oppname.nil? ? "" : match.oppname %></td>
				<td><%= match.numturns.nil? ? "" : match.numturns %></td>
				<td><%= match.duration.nil? ? "" : seconds_to_short_readable(match.duration) %></td>
				<td><%= match.created_at.in_time_zone(current_user.profile.time_zone).strftime("%H:%M %Y-%m-%d") %></td>
				<td class="cl-effect-3">
					<% if type == "Arena" %>
						<%= link_to(" Edit", edit_arena_path(match), class: 'btn default btn-xs purple fa fa-pencil-square-o') %>
					<% else %>
						<%= link_to(" Edit", edit_constructed_path(match), class: 'btn default btn-xs purple fa fa-pencil-square-o') %>
					<% end %>
					<%= link_to(" Delete", match, method: :delete, data: { confirm: 'Are you sure?' }, class: 'btn default btn-xs red fa fa-trash-o') %>
					<% unless match.notes.blank? %>
						<span class= 'btn default btn-xs blue fa fa-file-text-o' title="<%= match.notes %>" rel="tooltip"> Notes</span>
					<% end %>
				</td>
			</tr>
		<% end %>
	</tbody>	
</table>
<%= will_paginate(matches, renderer: WillPaginate::ActionView::LinkRenderer) %>
<script type="text/javascript">
	$('#matchesFilter select').change(function() {
		$('#matchesFilter').submit();
	});
	$('#matchesFilterSubmit').hide();
</script>
